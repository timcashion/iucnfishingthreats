---
title: "Low cost conservation: Fisheries gear threats to marine species"
author: "Tim Cashion, Travis Tai, Daniel Pauly, and U. Rashid Sumaila"
date: "`r date()`"
output: 
  bookdown::word_document2:
    default
  bookdown::html_document2:
    default

bibliography: MyCollection.bib
always_allow_html: yes
biblio-style: "apalike"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=F, warning=F)
source("./R/common_fxns.R")

packages <- c("tidyverse", 
              # "maptools", 
              "rgdal",
              # "sf", 
              "wesanderson",
              # "sp",
              # "raster"
              "parallel",
              "bookdown",
              "knitr"
              )
ipak(packages)


fig_output <- TRUE
if(fig_output==TRUE){ #Erase existing manuscript figs and re-output
  unlink(paste("./figs/manuscript_figs/", list.files("./figs/manuscript_figs"), sep=""))
}

```

```{r plot-aes}
pal <- wes_palette(name = "Zissou1", n=100, type = c("continuous"))
zissou5 <- wes_palette(name="Zissou1")


theme_set(theme_classic())
#GFW Themes
theme_gfw_paper <-  theme(text = element_text(face="bold", size=12),
        axis.text.x = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.line.x = element_line(colour = "black", size = .5),
        axis.line.y = element_line(colour = "black", size = .5),
        legend.position = "bottom",
        axis.title.y = element_text(size = 12, margin=margin(0,15,0,0)),
        axis.title.x = element_text(size = 12, margin=margin(15,0,0,0)),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.margin = unit(c(1,1,1,1), "cm")
        )

cont_fill = 'white'#'grey30' #'grey80'
back_fill =  'white'#'#202A50' #'black' #'#1F2A4F'
cont_color = 'grey60'#'grey30'
#color_grad = c( "#414487", "#2A788E", "#22A884", "#7AD151","#FDE725","#FFC04C")
color_grad = c("#C6DBEF", "#9ECAE1", "#6BAED6","#4292C6" ,"#2171B5", "#084594") #blues
null_colour <- "white"

```

```{r data}

#Establish list of marine species 
all_species <- data.table::fread(file.path(dir_data, paste( "iucn_species_list_", api_version,".csv", sep="")))

marine_species <- read.csv(file.path(dir_data, paste( "spp_marine_from_", api_version,".csv", sep="")))
#### Align with threats and narrative text: ####
species_threats <- read.csv(file.path(dir_data, "species_fishing_threats.csv"), stringsAsFactors = F)
colnames(species_threats) <- gsub(colnames(species_threats), pattern="result\\.", replacement="")
risk_codes <- read.csv(file.path(dir_data, "risk_code_lookup.csv"), stringsAsFactors = F)
species_threats <- species_threats %>% left_join(risk_codes, by=c("category"="code"))
species_threats <- species_threats %>%
  dplyr::select(iucn_sid, class_name, scientific_name, code_current, cat_score) %>%
  unique()


# threatened_status <- c("VU", "CR", "EN")
# species_threats <- species_threats %>% filter(code_current %in% threatened_status)
text_threats <- read_csv(file.path(dir_data, "narrative_threats_output_tidy.csv"))

cell_size <- "05"

spat_files <- list.files(file.path(paste(dir_rasters, "_", cell_size, sep="")))
raster_read <- function(filename){
  id <- gsub(filename, pattern="iucn_sid_", replacement = "")
  id <- gsub(id, pattern=".csv", replacement = "")
  spp_rast <- data.table::fread(file.path(paste(dir_rasters, "_", cell_size, sep=""), filename))
  if(nrow(spp_rast)>0){
    spp_rast$iucn_sid <- as.numeric(id)
    return(spp_rast)
  }
}
spat_list <- parallel::mclapply(spat_files, raster_read)
spat_list <- bind_rows(spat_list)
cell_ids <- read.csv(file.path(dir_spatial_csvs, "cell_ids.txt"), header=F, col.names = c("cell_id", "lon", "lat"))
cell_id_area <- data.table::fread(file.path(dir_spatial_csvs, "cell_id_area_05.csv"))
allocated_gear_catch <- data.table::fread(file.path(dir_data, "AllocatedSuperGearCatch.csv"))
allocated_gear_catch <-allocated_gear_catch %>% 
  left_join(cell_ids) %>% 
  left_join(cell_id_area) %>% 
  mutate(catch_km2 = mean_catch/water_area)
allocated_gear_value <- data.table::fread(file.path(dir_data, "AllocatedSuperGearValue.csv"))
allocated_gear_value <-allocated_gear_value %>% 
  left_join(cell_ids) %>% 
  left_join(cell_id_area) %>% 
  mutate(value_km2 = mean_value/water_area)

spat_data <- spat_list %>% 
  left_join(cell_ids, by="cell_id") %>%
  mutate(category = if_else(is.na(rgn_category), global_category, rgn_category)) %>% 
  left_join(risk_codes %>% dplyr::select(-c(category)), by=c("category"="code"))

gfw_2016 <- data.table::fread(file.path(dir_spatial_csvs, "gfw_2016_01.csv"))

```

```{r map-setup}

#Load it!
#World <- readOGR(file.path(dir_spatial, "ne_10m_coastline/ne_10m_coastline.shp"))
World <- readOGR(file.path(dir_spatial, "ne_10m_coastline/ne_10m_land_no_casp.shp"), verbose=FALSE) #Switched to using without Caspian Sea for better visuals.

# fortify.shape <- function(x){
#   x@data$id <- rownames(x@data)
#   x.f = fortify(x, region = "id")
#   x.join <- inner_join(x.f, x@data, by = "id")
# }

Forty_World<- fortify(World)

base_map <- ggplot() +
  geom_path(data = Forty_World, aes(x = long,
                                    y = lat,
                                    group = group
  ),
  color = "black",
  size = 0.25) +
  theme_classic() + 
  labs(list(title = "",
            x = "Longitude",
            y = "Latitude")) +
  scale_fill_gradientn(colours = pal) +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  labs(fill="") + 
  NULL 


```

Target Journals: Science, Nature, PNAS, Science Advances, Nature Sustainability, Conservation Biology  

Potential collaborators:  Casey O'Hara; Ben Halpern, Vicky Lam      

## Abstract  
Many marine species globally are threatened by fishing pressure and harmful interactions with fisheries. However, the threats they face are particular to the fishing methods used and are not ubiquitous to fisheries. Therefore, the protection these Threatened species likely need is contingent on their threats and not necessarily related to all fisheries. Here, we undertake a novel analysis of Threatened marine species to identify their major fisheries threats by fishing method and overlap this with two spatially explicit databases of fisheries catches and fishing effort by fishing method. 

Keywords: fishing method, IUCN, fishing pressure, conservation

## Introduction

```{r text-values}
iucn_species <- data.table::fread(file.path(dir_data, paste("iucn_species_list_", api_version, ".csv", sep="")))
iucn_species <- iucn_species %>% select(result.taxonid, result.scientific_name) %>% distinct()
unique_species <- length(iucn_species %>% pull(result.scientific_name) %>% unique())

iucn_marine_num <- data.table::fread(file.path(dir_data, paste("spp_marine_from_", api_version, ".csv", sep="")))
iucn_marine_num <- length(iucn_marine_num %>% left_join(iucn_species, by=c("iucn_sid"="result.taxonid")) %>% pull(result.scientific_name) %>% unique())


fishing_threat_num <- length(data.table::fread(file.path(dir_data, "species_fishing_threats.csv")) %>% filter(code=="5.4") %>% left_join(iucn_species, by="result.scientific_name") %>% pull(result.scientific_name) %>% unique())
gear_threat_num <- length(data.table::fread(file.path(dir_data, "narrative_threats_output_tidy.csv")) %>% left_join(iucn_species, by=c("scientific_name"="result.scientific_name")) %>% pull(scientific_name) %>% unique())


trawler_unspec_num <- length(text_threats %>% filter(super_code =="trawl unspec") %>% pull(scientific_name) %>% unique())

#Numbers used in text
fishing_threat_perc <- round(fishing_threat_num/iucn_marine_num * 100, 1)
iucn_marine_num <- prettyNum(iucn_marine_num, big.mark = ",")
fishing_threat_num <- prettyNum(fishing_threat_num, big.mark = ",")
gear_threat_num <- prettyNum(gear_threat_num, big.mark = ",")

```

Fishing is a major threat to many marine species globally. However, different fishing gears are heterogeneous in their spatial extent and their impacts on different species. Therefore, treating different fisheries homogenously with regard to their spatial management likely causes unneeded conflict between fisheries and conservation priorities, and may impose too high costs without necessarily achieving their intended conservation benefits. Here, we aim to clarify this through a greater examination of fisheries threats related to specific fishing gears and their spatial overlap with species of conservation concern. Recent studies have highlighted the spatial extent of fisheries [@Kroodsma2018a; @Amoroso2018], as well as the fisheries risk to species of conservation [@Queiroz2019]. While fisheries pose obvious conservation concerns for both targeted and incidentally captured species, they also provide livelihoods and food security to millions and billions, respectively [@FAO2018]. Therefore, the goals of fisheries and conservation must be balanced to minimize the costs and maximize the benefits where possible. 

Here, we establish the first estimate of large-scale conservation trade-offs when protecting species from their major fishing gear threats. This analysis is based off `r gear_threat_num` marine species included in the IUCN Red List with specific fishing gears listed as threats. We combine these data with a spatial catch by gear fisheries database [@Pauly2015], and a spatial industrial fishing effort database [@Kroodsma2018a]. We use gear threats by species described by the IUCN, and weight IUCN conservation status on a linear scale (in line with [@OHara2019]) to derive a weighted threat score for all marine areas of the world. We then combine this with fisheries catch and profit data by gear type, as well as fishing effort data to highlight areas of trade-offs and synergies between fisheries conservation. A major aim is to highlight areas with low-cost trade-offs between fisheries and conservation, and areas of high conservation concern that are also highly important to fisheries where there is competition between fisheries and conservation objectives. 
<!--TT: True! Counteracting goals for society, yet there is detailed literature on how our human-centric goals for 'ocean health' need to include both of these: conservation for increased biodiversity, and equitable and sustainable (artisanal) fishing opportunities to support society. Could be a good discussion point-->. 


<!-- RS: Include a brief review of earlier efforts at doing at doing this kind of analysis, e.g. Cheung and Sumaila)-->

## Results

### Fishing threats to IUCN species
For the `r iucn_marine_num` marine species included on the IUCN Red List, fishing is identified as a threat to `r fishing_threat_num` of them (`r fishing_threat_perc`%) by the IUCN (Threat category 5.4: fishing and harvesting aquatic resources). This occurs from large- and small-scale sectors, and from intentional and unintentional capture (Figure \@ref(fig:fishing-threat)). According to the identified threats, the small-scale sector is a threat to a greater number of species than both the intentional and unintentional capture by the large-scale sector. Interestingly, most of these impacts are identified to be of low or of an unknown impact with very few species having fishing identified as a medium or high impact threat on their population. 

```{r fishing-threat, fig.cap="Threat to species by level of impact and IUCN fisheries impact category", fig.width=8}
fishing_threats <- read.csv(file.path(dir_data, "species_fishing_threats.csv"))
colnames(fishing_threats) <- gsub(colnames(fishing_threats), pattern="result\\.", replacement="")
fishing_threats$title <- gsub(fishing_threats$title, pattern=" \\[harvest\\]", replacement = "")
fishing_threats$score_numeric <- gsub(fishing_threats$score, pattern=".*\\: ", replacement="")
fishing_threats$score_numeric <- as.numeric(fishing_threats$score_numeric)
fishing_threats$score <- gsub(fishing_threats$score, pattern="\\: .*", replacement="")
fishing_threats$score[fishing_threats$score=="Past Impact"] <- "No/Negligible Impact"
fishing_threats$score[fishing_threats$score=="(Not specified)"] <- "Unknown"
fishing_threats$score[is.na(fishing_threats$score)] <- "Unknown"
fishing_threats$score <- fct_relevel(fishing_threats$score, c("No/Negligible Impact", "Unknown", "Low Impact", "Medium Impact", "High Impact"))
fishing_threats_plot <- fishing_threats %>% 
  filter(code != "5.4") %>% 
  group_by(title, score) %>% 
  summarize(Count=n()) %>% 
  ungroup() %>% 
  mutate(title = fct_reorder(title, Count)) %>% 
  ggplot(aes(x=title, y=Count, fill=score)) +
  scale_fill_manual(values=zissou5) + 
  geom_col() + 
  coord_flip() +
  xlab("Threat") +
  ylab("Number of species") + 
  labs(fill="Level of impact") +
  scale_x_discrete(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  NULL
fishing_threats_plot
if(fig_output==TRUE){
  ggsave(file.path(dir_manuscript_figs, "fishing-threat.png"), dpi=300, width=8)
}
```

Within marine Red List species, over 2500 have 'trawls' listed as a source of their capture. While there are many species at an elevated risk of extinction (Near Threatened and higher) many fall into the Least Concern and Data Deficient categories within these gear types. While the top results are generally more vague gear terms, they unsurprisingly have a higher number of matches as they could be attributable to several types of fishing gear (e.g., trawl nets, gillnets, seine nets all fall under 'nets'). The more specific gear categories identified are used in the remaining parts of the analysis (Table SXX). 


```{r gear-threats, fig.cap="Fishing gear terms by number of species where that gear is mentioned in 'Threats' or 'Use and Trade' text"}
text_threats <- read.csv(file.path(dir_data, "narrative_threats_output_tidy.csv"))

exclude <- "trawlers"

iucn_cols <- IUCNpalette::iucn_palette(category="All", exclude=c("NE", "CO")) 

iucn_species <- all_species %>% dplyr::select(result.taxonid, result.category)
risk_codes <- read.csv(file.path(dir_data, "risk_code_lookup.csv"), stringsAsFactors = F)
iucn_species <- iucn_species %>% left_join(risk_codes, by=c("result.category"="code"))

gear_terms_threats_plot <- text_threats %>% 
  filter(!super_code %in% exclude) %>% 
  left_join(iucn_species , by=c("iucn_sid"="result.taxonid")) %>% 
  filter(code_current != "EX") %>% 
  group_by(super_code, code_current) %>% 
  summarize(Count=sum(threat)) %>% 
  ungroup() %>% 
  group_by(super_code) %>% 
  mutate(Total=sum(Count)) %>% 
  ungroup() %>% 
  mutate(super_code = fct_reorder(str_to_sentence(super_code), Total)) %>% 
  mutate(code_current = fct_relevel(code_current, c("DD", "LC", "NT", "VU", "EN", "CR", "EX"))) %>% 
  mutate(code_current = fct_relevel(code_current, rev(c("DD", "LC", "NT", "VU", "EN", "CR", "EX")))) %>% 
  ggplot(aes(x=super_code, y=Count, fill=code_current)) +
  geom_col() + 
  coord_flip() +
  xlab("Fishing gear threat") +
  ylab("Number of species") + 
  labs(fill="IUCN category") + 
  scale_fill_manual(values = rev(iucn_cols)) +
  scale_x_discrete(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  NULL
gear_terms_threats_plot
if(fig_output==TRUE){
  ggsave(file.path(dir_manuscript_figs, "gear-threats.png"), dpi=300)
}
```

From the gear types we have previously identified we see again that bottom trawl fisheries have the greatest number of species. However, we see that it dominates the DD, LC, and NT categories while gillnet gears have the most number of species in the Threatened categories (Vulnerable, Endangered, and Critically Endangered).  

```{r gear-threat-col-chart, fig.cap="Gear threats across current IUCN Red List status and gear types", fig.width=10, fig.height=5}

text_threats <- read.csv(file.path(dir_data, "narrative_threats_output_tidy.csv")) 

weighted_gear_threats <- left_join(species_threats, text_threats)
weighted_gear_threats <- weighted_gear_threats %>% 
  mutate(gear_threat = threat*cat_score) %>% 
  filter(is.na(super_code)==F)
  

weighted_gear_threats <- weighted_gear_threats %>% 
  mutate(gear_threat = threat*cat_score)
gears_to_include <- c("Bottom trawl", "Purse seine", "Longline", "Small scale", "Gillnet")
# iucn_cols <- IUCNpalette::iucn_palette(category="All", exclude=c("NE", "CO")) 
# 
# weighted_gear_threats_plot1 <- weighted_gear_threats %>% 
#   group_by(super_code, code_current) %>% 
#   summarize(Count=sum(threat, na.rm=TRUE)) %>% 
#   ungroup() %>% 
#   mutate(super_code = fct_reorder(str_to_sentence(super_code), Count)) %>% 
#   mutate(code_current = fct_relevel(code_current, c("DD", "LC", "NT", "VU", "EN", "CR", "EX"))) %>% 
#   filter(super_code %in% gears_to_include) %>% 
#   ggplot(aes(x=code_current, y=Count, fill=code_current)) +
#   geom_col() + 
#   xlab("Fishing gear threat") +
#   ylab("Number of sspecies") + 
#   labs(fill="IUCN Category") + 
#   facet_wrap(~super_code, nrow=1) + 
#   theme(strip.background = element_blank(), strip.text = element_text()) +
#   scale_fill_manual(values = iucn_cols) +
#   NULL
# weighted_gear_threats_plot1

weighted_gear_threats_plot2 <- weighted_gear_threats %>% 
  group_by(super_code, code_current) %>% 
  summarize(Count=sum(threat, na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(super_code = fct_reorder(str_to_sentence(super_code), Count)) %>% 
  mutate(code_current = fct_relevel(code_current, c("DD", "LC", "NT", "VU", "EN", "CR", "EX"))) %>% 
  filter(super_code %in% gears_to_include) %>% 
  ggplot(aes(x=super_code, y=Count, fill=super_code)) +
  geom_col() + 
  xlab("") +
  ylab("Number of species") + 
  labs(fill="Gear type") + 
  facet_wrap(~code_current, nrow=1) + 
  theme(strip.background = element_blank(), strip.text = element_text(), axis.text.x=element_blank()) +
  #theme(strip.background = element_rect(fill=iucn_cols), strip.text = element_text(), axis.text.x=element_blank()) + #Fill by IUCN category is quite complicated. Leaving this for now. 
  scale_fill_manual(values = wes_palette("Darjeeling2")) +
  scale_x_discrete(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  NULL
weighted_gear_threats_plot2

# gears_to_include <- c("Trawlers", "Bottom trawl", "Purse seine", "Longline", "Small scale", "Pelagic trawl", "Gillnet", "Squid jigger", "Drifting longlines")
# gear_threats_plot3 <-  weighted_gear_threats %>% 
#   filter(code_current != "EX") %>% 
#   group_by(super_code, code_current) %>% 
#   summarize(Count=sum(threat, na.rm=TRUE)) %>% 
#   ungroup() %>%
#   group_by(super_code) %>% 
#   mutate(Total=sum(Count)) %>% 
#   ungroup() %>% 
#   mutate(super_code = fct_reorder(str_to_sentence(super_code), Total)) %>% 
#   filter(super_code %in% gears_to_include) %>% 
#   mutate(code_current = fct_relevel(code_current, c("DD", "LC", "NT", "VU", "EN", "CR", "EX"))) %>% 
#   mutate(code_current = fct_relevel(code_current, rev(c("DD", "LC", "NT", "VU", "EN", "CR", "EX")))) %>% 
#   ggplot(aes(x=super_code, y=Count, fill=code_current)) +
#   geom_col() + 
#   coord_flip() +
#   xlab("Fishing gear threat") +
#   ylab("Number of species") + 
#   labs(fill="IUCN category") + 
#   scale_fill_manual(values = rev(iucn_cols)) +
#   scale_x_discrete(expand=c(0,0)) +
#   scale_y_continuous(expand=c(0,0)) +
#   NULL
# gear_threats_plot3
if(fig_output==TRUE){
  ggsave(file.path(dir_manuscript_figs, "gear-threat-col-chart.png"), dpi=300, width=10, height=5)
}
```

### Spatial overlap of fisheries and marine species
We find substantial overlap between fisheries activity (as determined by spatially allocated catches) and the occurrence and threat level of taxa where this fishing gear is a threat (Fig SXX). However, we also find many areas where the current fishing effort and catches are low but still likely presenting a threat to species in that area (Fig SXX). 

<!--TT: I know you like the Zissou theme, but I find it a bit distracting when almost the whole ocean is 'blue' as a value and yet represents values of little to zero. I would suggest having each variable as a different colour scale/shading (but totally up to you).

Also, I think that the resolution of the maps is a bit low to see the threat impacts around the coastal margins. Would a panel of maps showing different regions (N Atlantic, China, SE Asia) be feasible? Maybe a bit tough with the different layers PLUS region mapping. If your main message is the WTS (indirectly a measure of spp occurence by gear) and $/WTS, then you could put the catch and spp occurence maps in supp mat. 
-->
In Figure \@ref(fig:map-grid), the revenue (2010 real USD) per weighted score (by gear type) shows high values in red indicating areas with large fisheries value and low conservation value, and in blue the opposite of areas with low fisheries value in comparison to their conservation value. Interestingly, many of the areas with the lowest hanging fruit are in the high seas (Figure \@ref(fig:map-grid)). This shows areas where it will be more difficult (red) to protect from the relevant fishing gear due to the high value of resource that is currently being used there. In contrast, it highlights areas of potential easy wins for conservation (blue) to protect areas of high conservation concern with currently low levels of fisheries revenue. 

<!-- RS: Difficult to read the graph labels.-->

<!--
Come back to this part of the early results. Really weak right now. 
-->

```{r cost-of-conservation-plot-function}
cost_of_conservation <- function(gear=NA, text_threats=text_threats, allocated_gear_value=allocated_gear_value, spat_data=spat_data){
  gear_species <- text_threats %>%
    filter(super_code==gear)
  fishing_value <- allocated_gear_value %>% 
    filter(super_code==gear) %>% 
    group_by(lon, lat) %>% 
    summarize(value_km2 = sum(value_km2, na.rm=TRUE)) %>% 
    ungroup()
  threat_dat <- spat_data %>% 
    filter(iucn_sid %in% gear_species$iucn_sid)  %>% 
    group_by(lon, lat) %>% 
    summarize(n = sum(presence, na.rm = T),
              weighted_score = sum(cat_score, na.rm = T)) %>% 
    ungroup()
  map_dat <- full_join(fishing_value, threat_dat) %>% 
    mutate(weighted_score = ifelse(is.na(weighted_score), 0, weighted_score),
         value_km2 = ifelse(is.na(value_km2), 0, value_km2),
         n = ifelse(is.na(n), 0, n)) %>% 
    mutate(value_km2_per_n = value_km2/n,
           value_km2_per_weight = value_km2/weighted_score,
           score_per_dollar = weighted_score/value_km2)
  map_dat <- map_dat %>% 
    mutate(score_per_dollar = ifelse(is.na(score_per_dollar),0, score_per_dollar))
  cost_conservation_plot <- base_map +
    geom_tile(data=map_dat, aes(x=lon, y=lat, fill=score_per_dollar)) +
    labs(fill="$ per weighted score",
         title = "",
         subtitle = str_to_sentence(gear), 
           x = "Longitude",
         y = "Latitude") +
    scale_fill_gradientn(colors=pal, trans="log10", na.value=null_colour)
  return(cost_conservation_plot)
  }

```


```{r gfw-fei-function}

gfw_fei <- function(gear=NA, full_extent=full_extent){
  
  effort_dat <- data.table::fread(file.path(dir_output, paste(gear, "_GFW_effort", ".csv", sep="")))
  threat_dat  <- data.table::fread(file.path(dir_output, paste(gear, "_IUCN_threat", ".csv", sep="")))
  # breaks_gear <- 10^seq(1,5,1)
  # labels_gear <- as.character(breaks_gear)
  # breaks_gear <- log10(breaks_gear)
  map_dat <- full_extent %>% left_join(full_join(effort_dat, threat_dat)) %>% 
    mutate(weighted_score = ifelse(is.na(weighted_score), 0, weighted_score),
         fishing_hours = ifelse(is.na(fishing_hours), 0, fishing_hours),
         n = ifelse(is.na(n), 0, n)) %>% 
    mutate(biorisk = weighted_score/n,
           FEI= weighted_score*fishing_hours/n)

  # map_dat <- map_dat %>% 
  #   mutate(FEI = ifelse(FEI>max_val, max_val, FEI),
  #          FEI = ifelse(FEI>min_val, min_val, FEI))
  fei_plot <- base_map + 
    geom_tile(data=map_dat %>% filter(FEI>0), 
              aes(x=lon, y=lat, fill=FEI)) +
    labs(fill="Fishing Exposure Index", x="Longitude", y="Latitude") +
    scale_fill_gradientn(colors = pal, trans="log10", 
                          breaks=c(0.1, 10, 1000), labels=c("0.1", "10", "1000"), limits= c(0.01, 10000),
                          na.value=null_colour) + 
    NULL
  return(fei_plot)
  }


```

```{r map-grid, fig.cap="Indicators of conservation trade-offs and areas of high concern. Top row is the fisheries revenue in a grid cell divided by the Weighted Threat Score in that cell. Bottom row is the fisheries exposure index (using Global Fishing Watch data) calculated as the product of fishing effort (in vessel hours) multiplied by the sum of the numeric threat score of species threatened by that gear in that cell.", fig.width=20, fig.height=12}

full_extent <- cell_ids %>% left_join(cell_id_area) %>% 
  mutate(water_area = ifelse(is.na(water_area), 0, water_area))

max_val <- 10000
min_val <- 0.001 


ll_wts <- cost_of_conservation(gear="longline", text_threats=text_threats, allocated_gear_value=allocated_gear_value, spat_data=spat_data)
bt_wts <- cost_of_conservation(gear="bottom trawl", text_threats=text_threats, allocated_gear_value=allocated_gear_value, spat_data=spat_data)
ll_fei <- gfw_fei(gear="longline", full_extent=full_extent)
bt_fei <- gfw_fei(gear="trawlers", full_extent=full_extent)


map_grid <- cowplot::plot_grid(ll_wts,
            bt_wts,
            ll_fei,
            bt_fei,
            align = "v",
            rel_widths = c(1,1,1,1),
            rel_heights = c(1,1,1,1),
            ncol = 2
  )
print(map_grid)
if(fig_output==TRUE){
  ggsave(file.path(dir_manuscript_figs, "map-grid.png"), dpi=900, width=20, height=12)
}
```


Similar patterns exist at a more refined spatial scale (0.1° by 0.1° instead of 0.5° by 0.5°) in the Fishing Exposure Index (Figure \@ref(fig:map-grid)). However, the gear types identified in the Global Fishing Watch data are different than identified in *Sea Around Us* data and thus can draw interesting examples. The adapted Fishing Exposure Index reveals different hotspots by gear type. Longline gears are widely distributed with relatively low effort leading to lower relative values on the Fishing Exposure Index, whereas trawlers are much more concentrated in coastal areas, and highly overlap with species of concern in China's and Europe's coastal waters. 

Here, we present a harmonized view of areas of fisheries concern across gear types (Figure \@ref(fig:harmonized-gear-map-iucn)). Although similar to other expected areas of concern for biodiversity hotspots [@OHara2019] and fisheries pressure [@Pauly2015; @Kroodsma2018a], our analysis normalizes the threat to these species by their specific fishing gear related threats. Areas with multiple gears are more likely to have higher scores as there is more exposure to fishing gear related threats. The highest weighted threat scores occur in the Mediterranean Sea and off the coast of East Asia down to Australia. 

<!-- Pressure on the Australian coast will be a bit surprising to many – can you explain why this likely true? -->

```{r harmonized-gear-map-iucn, fig.cap="Weighted threat harmonized across gear types", fig.width=8, fig.height=5}
files <- list.files(dir_output)[grepl(list.files(dir_output), pattern="catch_threat.csv")]
files <- file.path(dir_output, files)
harmonized_list <- lapply(files, data.table::fread)
harmonized_threats <- bind_rows(harmonized_list)
harmonized_threats <- harmonized_threats %>% group_by(lon, lat) %>% 
  summarize(catch_km2=sum(catch_km2, na.rm=TRUE),
            n=sum(n, na.rm=TRUE),
            weighted_score=sum(weighted_score, na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(weighted_score_norm = 100*(weighted_score/max(weighted_score)))

# harmonized_map <- base_map + 
#     geom_tile(data=harmonized_threats, 
#               aes(x=lon, y=lat, fill=weighted_score)) +
#     labs(fill="Weighted threat\nscore", x="Longitude", y="Latitude")
# harmonized_map

harmonized_map <- base_map + 
    geom_tile(data=harmonized_threats, 
              aes(x=lon, y=lat, fill=weighted_score)) +
    labs(fill="Log (Weighted threat\nscore)", x="Longitude", y="Latitude") +
  scale_fill_gradientn(colors = pal, trans="log10", 
                          breaks=c(0.1, 1, 10, 100), labels=c("0.1", "1", "10", "100"),
                          na.value=null_colour) +
  NULL
harmonized_map
if(fig_output==TRUE){
  ggsave(file.path(dir_manuscript_figs, "harmonized-gear-map-iucn.png"), dpi=900, width=8, height=5)
}
```


```{r gear-measures-summary}
sau_gear_types <- unique(allocated_gear_catch$super_code)
iucn_gear_types <- unique(text_threats$super_code)
gear_types <- iucn_gear_types[grep(iucn_gear_types, pattern=paste(sau_gear_types, collapse="|"))]

gear_threats <- spat_data %>% 
  left_join(text_threats) %>% 
  group_by(lon, lat, super_code) %>% 
  summarize(n = sum(presence, na.rm = T),
            weighted_score = sum(cat_score, na.rm = T)) %>% 
  ungroup()

density_data <- full_join(allocated_gear_value, gear_threats) %>% 
  filter(super_code != "other") %>% 
  filter(super_code %in% gear_types) %>% 
  mutate(weighted_score = ifelse(is.na(weighted_score), 0, weighted_score),
         value_km2 = ifelse(is.na(value_km2), 0, value_km2),
         n = ifelse(is.na(n), 0, n)) %>% 
  mutate(super_code = fct_drop(super_code)) %>% 
  mutate(value_km2_per_n = value_km2/n,
         value_km2_per_weight = value_km2/weighted_score,
         score_per_dollar = weighted_score/value_km2)


#Summary table
summary_tab <- density_data %>% 
  filter(is.na(mean_value)==F & is.na(weighted_score)==F) %>% 
  group_by(super_code) %>% 
  mutate(biodiv_risk = weighted_score/n) %>% 
  summarize(value_km2 = round(mean(value_km2),2),
            n = round(mean(n),1), 
            weighted_score = round(mean(weighted_score),2),
            biodiv_risk = round(mean(biodiv_risk, na.rm=TRUE),2)) %>% 
  mutate(value_km2_per_weight = round(value_km2/weighted_score,2))
#Text values:
#Mean and median by gear type
bt_value <- round(summary_tab %>% filter(super_code=="bottom trawl") %>% pull(value_km2),0)
bt_risk <- summary_tab %>% filter(super_code=="bottom trawl") %>% pull(biodiv_risk)
bt_n <- summary_tab %>% filter(super_code=="bottom trawl") %>% pull(n)
bt_value_score <- summary_tab %>% filter(super_code=="bottom trawl") %>% pull(value_km2_per_weight)

ll_value <- round(summary_tab %>% filter(super_code=="longline") %>% pull(value_km2),0)
ll_risk <- summary_tab %>% filter(super_code=="longline") %>% pull(biodiv_risk)
ll_value_score <- summary_tab %>% filter(super_code=="longline") %>% pull(value_km2_per_weight)


summary_tab <- summary_tab %>% 
  mutate(super_code = str_to_sentence(super_code))
colnames(summary_tab) <- c("Gear type", "$/km^2^", "Number of species", "Weighted Threat Score", "Biodiversity Risk Score", "\\$/km^2^ /WTS")


```

<!-- Economists will question why we are using revenues and not profits. We should find a way to use our cost data to calculate profits. This is particularly important because we are using revenue per area, which automatically disadvantages longlines, for example, because they operate over a large spatial area. The cost of fishing by longlines per unit area is likely to be orders of magnitude lower than for bottom trawlers, for example.  -->



Globally, bottom trawl fisheries bring in fisheries revenues of \$`r toString(bt_value)` per km^2^ (Table \@ref(tab:gear-summary-table)). However, they occur in cells with an average of `r toString(bt_n)` species at risk to this gear, with an average biodiversity risk score of Near Threatened (`r toString(bt_risk)`). However, their generally high value catches make them perform relatively well on the revenue per weighted threat score score (`r toString(bt_value_score)`). In contrast, longline fisheries generate a low value per area occupied (\$`r toString(ll_value)`) as they occur over a large spatial area. While they operate in areas with a similar biodiversity risk score as bottom trawl fisheries (`r toString(ll_risk)`), they do so with much lower returns meaning they produce less fisheries revenues per conservations risk (weighted threat score) than bottom trawl fisheries (`r toString(ll_value_score)`). Interestingly, small-scale fisheries and their gears perform similarly to bottom trawl fisheries on a revenue per weighted threat score metric. 

<!--TT: Is $/km2 a reasonable measure? This is similar to the Kroodsma-Amaroso scale issue on the resolution of the maps; but maybe if it's all relative to the other gears then is it fine? 

This table is also a bit confusing because you indicate the '$/km2 /WTS' with a high value is a [fisheries > conservation], and a low value is [conservation > fisheries], and viceversa for WTS/ $/km2. This makes sense. I believe your description above for the figure panels for $/WTS is backwards then, where you indicate areas in red (high value) is [conservation > fisheries]. Am I understanding that correctly then? 

Should also indicate the mean values are by 0.5x0.5 cell-->


```{r gear-summary-table}
knitr::kable(summary_tab, caption= "Summary measures of fisheries conservation concern and value generated by gear type at a 0.5 by 0.5 degree scale.")
```

If we consider each cell an independently managed grid, we can examine the trade-offs required in each based on their fisheries revenue value and conservation value (Figure \@ref(fig:conceptual-figure-gears)). We find that although bottom trawl fisheries operate in many cells of conservation concern (high 'Weighted threat score' values), they are also generating substantial fisheries revenue from these fisheries. Gillnets, alternatively, have a large group of cells that are below the median value for fisheries revenue and have high weighted threat scores. Pelagic trawls have fairly low weighted threat scores overall and thus the reduction in their use may not lead to large conservation gains. 

### Low-cost solutions to gear threats and easy conservation wins

Here, we present six major gear types that together account for 92% of global fisheries catches (landings and discards) [@Cashion2018a]. Bottom trawls, gillnets, and longlines have many more cells where the weighted threat score is higher than the median, especially in contrast to pelagic trawls, purse seines and small-scale gears. Among these higher impact gears, there is a diversity in the value of the fisheries revenue achieved in each grid cell. Interestingly, gillnet fisheries are operating in many areas of high conservation concern with fisheries revenues below the median value (across gear types). This demonstrates that the social costs of this gear are higher than previously thought, and may not be net positive given their relatively poor private revenues achieved (mainly below the median). In comparison, bottom trawl fisheries while overlapping on the weighted threat score dimension with gillnet fisheries, achieve higher revenues thus representing a conflict between conservation goals and fisheries goals. Small-scale gears and purse seine are more mixed with weighted threat scores not nearly as high as gillnet or bottom trawls, and a mix of high and low revenue areas. Pelagic trawls are often used solely for relatively low-value species (from krill to Alaska pollock), but have very low weighted threat scores throughout their range of fisheries revenues. 

```{r conceptual-figure-gears, fig.cap="Fisheries revenue and weighted score by cell (0.5 by 0.5 grid) for major gear types. Grey dashed lines indicate the median values  (excluding values of 0) across gear types for fisheries revenue per km^2^ and weighted threat score."}

sau_gear_types <- unique(allocated_gear_catch$super_code)
iucn_gear_types <- unique(text_threats$super_code)
gear_types <- iucn_gear_types[grep(iucn_gear_types, pattern=paste(sau_gear_types, collapse="|"))]

gear_threats <- spat_data %>% 
  left_join(text_threats) %>% 
  group_by(lon, lat, super_code) %>% 
  summarize(n = sum(presence, na.rm = T),
            weighted_score = sum(cat_score, na.rm = T)) %>% 
  ungroup()

density_data <- full_join(allocated_gear_value, gear_threats) %>% 
  filter(super_code != "other") %>% 
  filter(super_code %in% gear_types) %>% 
  mutate(super_code = fct_drop(super_code)) %>% 
  mutate(weighted_score = ifelse(is.na(weighted_score), 0, weighted_score),
         value_km2 = ifelse(is.na(value_km2), 0, value_km2),
         n = ifelse(is.na(n), 0, n)) %>% 
  mutate(value_km2_per_n = value_km2/n,
         value_km2_per_weight = value_km2/weighted_score,
         score_per_dollar = weighted_score/value_km2) 


plot_data <- density_data %>% 
  filter(super_code != "drifting longlines") %>% 
  mutate(super_code = str_to_sentence(super_code))
#Modified the medians to exclude 0 values. 
median_wts <- median(plot_data %>% filter(weighted_score!=0) %>% pull(weighted_score), na.rm=TRUE) 
median_valuekm2 <- median(plot_data %>% filter(value_km2!=0) %>% pull(value_km2), na.rm=TRUE)

line_colour <- "grey50"
plot_data %>% 
  ggplot(aes(x=value_km2, y=weighted_score, color=super_code)) +
  geom_point(alpha=0.2) + 
  scale_x_log10() + 
  xlab("$/km^2^") +
  ylab("Weighted threat score") +
  labs(color="Gear type") + 
  facet_wrap(~super_code) + 
  geom_hline(yintercept = median_wts, lty="dashed", color=line_colour) + 
  geom_vline(xintercept = median_valuekm2, lty="dashed", color=line_colour) +
  theme(strip.background = element_blank()) + 
  theme(legend.position = "none") + 
  NULL

if(fig_output==TRUE){
  ggsave(file.path(dir_manuscript_figs, "conceptual-figure-gears.png"), dpi=300)
}
```

### Protecting the high seas 
Areas beyond national jurisdiction (i.e., the high seas) have recently received increased attention for their protection for biodiversity and fishery gains [@Sumaila2015a; @White2014], while leading to little losses in terms of food security [@Schiller2018]. According to our framework, the high seas have cells in all four quadrants of our conceptual figure, but there is a large bias towards "Areas of low concern" and "Easy wins" (Figure \@ref(fig:high-seas)). This confirms earlier analysis of the lack of importance of high seas fisheries, and although the high seas is dominated by areas of low concern, it has vast amounts that fall into 'Easy wins' with very few cells in fishery prioritization or fishery competition. Therefore, the question may be changed from which parts of the high seas should we protect, to which parts of the high seas should remain as fishing areas? 

<!-- Cite Carl Walters on above idea (last sentence) -->
<!-- RS: Another question which some have raised earlier is whether we should fish in the high seas at all. I think we should raise this question here too.  -->
<!--TT: Hmm I'm concerned over the message of this figure below, in that a whole country's EEZ is labelled as one of the four categories. Makes sense that it could it is a stepping stone for which regions to focus on though. Could eezs be represented by ovals, where the horizontal size is the variation in the values for each cell? Not sure how this would look but just a suggestion. Could also do this by LME, or some other geographic region.-->

```{r high-seas, fig.cap="Scatterplot of cells within the High Seas (areas beyond national jurisdiction) according to their categories from our conceptual diagram. Each point is a 0.5 by 0.5 degree cell. Dashed lines indicated mean values of all cells (High Seas and EEZs).", fig.width=8}

cell_size <- "05"
eez_cell_ids <- read_csv(file.path(dir_spatial_csvs, paste("eez_cell_ids_", cell_size, ".csv", sep="")))
eez_ids <- read.csv(file.path(dir_spatial_csvs, "eez_ids.csv")) %>% 
  rename(eez_id = EEZID, eez = Name, entity=Entity) %>% 
  dplyr::select(eez_id, eez, entity)

eez_ids <- eez_ids %>% 
  mutate(eez = gsub(eez, pattern="ô", replacement="o"),
         entity = gsub(entity, pattern="ô", replacement="o"),
         eez = gsub(eez, pattern="é", replacement="e"),
         entity = gsub(entity, pattern="é", replacement="e"))


cell_ids <- read.csv(file.path(dir_spatial_csvs, "cell_ids.txt"), header=F, col.names = c("cell_id", "lon", "lat"))
cell_ids_area <- read.csv(file.path(dir_spatial_csvs, paste("cell_id_area_", cell_size,".csv", sep="")))
cell_ids <- cell_ids %>% left_join(cell_ids_area) %>% left_join(eez_cell_ids) %>% left_join(eez_ids)

cell_ids <- cell_ids %>% 
  mutate(eez = ifelse(is.na(eez) & water_area>0, "High seas", eez),
         entity = ifelse(is.na(entity) & water_area>0, "High seas", entity))


harmonized_threats <- bind_rows(harmonized_list)
harmonized_threats <- harmonized_threats %>% group_by(lon, lat) %>% 
  summarize(catch_km2=sum(catch_km2, na.rm=TRUE),
            n=sum(n, na.rm=TRUE),
            weighted_score=sum(weighted_score, na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(weighted_score = 100*(weighted_score/max(weighted_score)))
harmonized_threats <- harmonized_threats %>% left_join(cell_ids)
mean_catch_global <- mean(harmonized_threats %>% filter(catch_km2>0) %>% pull(catch_km2))
mean_wts <- mean(harmonized_threats %>% filter(weighted_score>0) %>% pull(weighted_score))

median_catch_global <- median(harmonized_threats %>% filter(catch_km2>0) %>% pull(catch_km2))
median_wts <- median(harmonized_threats %>% filter(weighted_score>0) %>% pull(weighted_score))

harmonized_threats$category <- NA
harmonized_threats <- harmonized_threats %>% 
  mutate(category = if_else(catch_km2 > mean_catch_global, 
                            if_else(weighted_score > mean_wts, "Fishery competition", "Fishery prioritization"), 
                            if_else(weighted_score > mean_wts, "Easy wins", "Area of low concern")))

harmonized_threats$category <- fct_relevel(as.factor(harmonized_threats$category), c("Fishery competition", "Fishery prioritization",  "Area of low concern", "Easy wins"))
text_color <- "grey10"
text_size <- 4
hs_distribution <- harmonized_threats %>% 
  filter(eez_id==0) %>% 
  ggplot(aes(x=weighted_score, y=log10(catch_km2), color=category)) +
  geom_point(alpha=0.3) + 
  geom_hline(yintercept= log10(mean_catch_global), lty="dashed") + 
  geom_vline(xintercept= mean_wts, lty="dashed") +
  # annotate("text", y = -3, x = 70, label = "Easy wins", size=text_size, color=text_color) +
  # annotate("text", y = 3, x = 70, label = "Fishery competition", size=text_size, color=text_color) +
  # annotate("text", y = 3, x = 3, label = "Fishery prioritization", size=text_size, color=text_color) +
  # annotate("text", y = -3, x = 3, label = "Areas of low concern", size=text_size, color=text_color) +
  labs(color="", x="Weighted threat score", y="Log10(Catch/km^2^)") + 
  theme(legend.position="none") +
  scale_color_manual(values=c(zissou5[5], zissou5[4], zissou5[2], zissou5[1])) +
  #scale_x_continuous(limits = c(-5,99)) +
  NULL
#hs_distribution
#ggsave("./figs/High seas distribution of cells on conceptual diagram.png", dpi=300, width=8, height=4)



hs_category_bar <- harmonized_threats %>% 
  filter(eez_id==0) %>% 
  ggplot(aes(x=category, fill=category)) +
  geom_bar() + 
  labs(fill="", x="", y="Number of cells") + 
  #theme(legend.position="none") +
  scale_fill_manual(values=c(zissou5[5], zissou5[4], zissou5[1], zissou5[2])) +
  theme(axis.text.x = element_blank()) + 
  scale_y_continuous(expand=c(0,0)) +
  NULL
#hs_category_bar

cowplot::plot_grid(hs_distribution, hs_category_bar, rel_widths = c(1.15,1.0), align="h")
#ggsave("./figs/HS Combined plot.png", dpi=300, width=8, height=4)
if(fig_output==TRUE){
  ggsave(file.path(dir_manuscript_figs, "high-seas.png"), dpi=300, width=8, height=4)
}
```


## Discussion

<!-- Start from something broader here. Cite Cheung and Sumaila on MPAs?  -->
While [@OHara2019] highlighted the areas for future conservation protection for MPAs, we identify the areas that would also meet with major or lesser fisheries overlap and thus competition. In these areas, we assume the placement of MPAs would be more contentious due to the reliance on these natural resources. We also highlight areas with the lowest fisheries revenues trade-offs for the most conservation protection. 

The majority of grid cells within the high seas are rated as being of low conservation concern and fisheries catches. The (lack of) importance to fisheries has been previously established, especially as they relate to food security [@Schiller2018]. While there are likely benefits to coastal fisheries from closing the high seas [@Sumaila2015a; @White2014], the conservation benefit for IUCN Red List species appears to be low on the whole. 

<!-- This analysis is static so can we say the same in the future too?-->
However, the number of cells that are categorized to be 'conservation prioritization' or 'easy wins' dwarfs the number of importance to fisheries (both 'fishery prioritization' and 'competition'). Therefore, while there are likely gains to be made from closing the high seas to fishing, marine protected areas placement should continue to focus on areas of high conservation concern and rich biodiversity found more frequently within the coastal margins of EEZs and those of high conservation value within the high seas. 

Our study may underestimate the impact of some fishing gears based on the descriptions of threats and use for each IUCN species. However, this is unlikely to be biased towards particular fishing methods as the threats generally highlight all known (fisheries) threats. In addition, as Data Deficient (DD) species are given a risk score of 0, we likely underestimate the risk to these species. For example, a quarter of Chondrichthyes (sharks, skates, and chimaeras) species currently categorized as data deficient were predicted to be Threatened [@Dulvy2014].

It is important to caveat our study knowing that we cannot fully account for the current extent of human's usage of the oceans, and this study has focused on fisheries and mainly large-scale fisheries. Small-scale fisheries are critical to coastal livelihoods across the world and must not be compromised by aims to overly broad conservation initiatives, but instead included when implementing actions to improve aspects of ocean health (e.g. [@Halpern2012]). 

<!-- Are we really achieving effective overly broad conservation?-->

In addition, while we use catch and fisheries revenues as a proxy for importance, these are not adjusted for their importance to the country (i.e., percentage of GDP from fisheries revenues or percentage of animal protein from locally caught fish), nor do they take into account differences in purchasing power parity where $1000 of fisheries revenues is much more valuable in poorer countries than in industrialized countries. 

<!--TT: Other points to consider
I'm not sure if you included effort data into the metrics you calculated, but it would be interesting to discuss the CPUE effects on the data here. Example, areas with high revenues but lower CPUE could also be leverage for management as an 'easier' win for conservation.  

Also, I'm not sure if you could include a measure of uncertainty in these estimates, especially for evaluating differences between aggregated measures (eg. gear types, eezs).

One thing I found interesting is the lower WTS scores for bottom trawling compared to longlining. I guess it's a mathematical result of the IUCN status and the number of spp, suggesting that longlining could affect more-threatened spp (and/or more total spp) than bottom trawling. I wonder how habitat destruction plays into the IUCN text when including threats/impacts. 
-->

## Conclusion
Our results highlight areas of high conservation concern for particular fishing gears, and areas of high overlap with multiple fishing gear threats and multiple species of conservation concern. We also highlight areas with the potential for low-cost fishing closures leading to maximum protection of species negatively affected by these fishing gears. Interestingly, gillnet fisheries represent a greater opportunity than the often demonized bottom trawl fisheries according to our analysis due to the high fisheries revenue derived from  many bottom trawl catches. This analysis can help inform future conservation planning with areas of low-cost trade-offs in comparison to areas with much higher costs for equal conservation benefits. 

## Acknowledgements
TC acknowledges funding support of the Social Sciences and Humanities Research Council of Canada and the 4-Year fellowship from the University of British Columbia. 


## References
