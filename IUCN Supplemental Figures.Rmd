---
title: "IUCN_Supplemental Figures"
author: "Tim Cashion et al."
date: "`r date()`"
output: bookdown::html_document2
bibliography: MyCollection.bib
always_allow_html: yes
biblio-style: "apalike"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=F, warning=F)
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}


packages <- c("tidyverse", 
              "rgdal",
              "wesanderson",
              "parallel",
              "bookdown",
              "knitr",
              "cowplot",
              "DiagrammeR"
              )
ipak(packages)

####Directories####
dir_data <- "./data"
dir_spatial <- "./spatial"
dir_figs <- "./figs"
dir_manuscript_figs <- "./figs/manuscript_figs"
dir_supplemental_figs <- "./figs/supplemental_figs"
dir_spatial_csvs <- "./spatial/csvs"
dir_rasters <- "./spatial/spp_rasters"
dir_output <- "./output"

source(here::here("R", "common_fxns.R"))


fig_output <- TRUE
if(fig_output==TRUE){ #Erase existing manuscript figs and re-output
  unlink(paste("./figs/supplemental_figs/", list.files("./figs/supplemental_figs"), sep=""))
}

```

```{r plot-aes}
pal <- wes_palette(name = "Zissou1", n=100, type = c("continuous"))
zissou5 <- wes_palette(name="Zissou1")
theme_set(theme_classic())
#GFW Themes
theme_gfw_paper <-  theme(text = element_text(face="bold", size=12),
        axis.text.x = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.line.x = element_line(colour = "black", size = .5),
        axis.line.y = element_line(colour = "black", size = .5),
        legend.position = "bottom",
        axis.title.y = element_text(size = 12, margin=margin(0,15,0,0)),
        axis.title.x = element_text(size = 12, margin=margin(15,0,0,0)),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.margin = unit(c(1,1,1,1), "cm")
        )

cont_fill = 'white'#'grey30' #'grey80'
back_fill =  'white'#'#202A50' #'black' #'#1F2A4F'
cont_color = 'grey60'#'grey30'
#color_grad = c( "#414487", "#2A788E", "#22A884", "#7AD151","#FDE725","#FFC04C")
color_grad = c("#C6DBEF", "#9ECAE1", "#6BAED6","#4292C6" ,"#2171B5", "#084594") #blues
null_colour = "grey50"
```

```{r data}

#Establish list of marine species 
all_species <- data.table::fread(file.path(dir_data, paste( "iucn_species_list_", api_version,".csv", sep="")))

marine_species <- read.csv(file.path(dir_data, paste( "spp_marine_from_", api_version,".csv", sep="")))
#### Align with threats and narrative text: ####
species_threats <- read.csv(file.path(dir_data, "species_fishing_threats.csv"), stringsAsFactors = F)
colnames(species_threats) <- gsub(colnames(species_threats), pattern="result\\.", replacement="")
risk_codes <- read.csv(file.path(dir_data, "risk_code_lookup.csv"), stringsAsFactors = F)
species_threats <- species_threats %>% left_join(risk_codes, by=c("category"="code"))
species_threats <- species_threats %>%
  dplyr::select(iucn_sid, class_name, scientific_name, code_current, cat_score) %>%
  unique()


# threatened_status <- c("VU", "CR", "EN")
# species_threats <- species_threats %>% filter(code_current %in% threatened_status)
text_threats <- read_csv(file.path(dir_data, "narrative_threats_output_tidy.csv"))

cell_size <- "05"

spat_files <- list.files(file.path(paste(dir_rasters, "_", cell_size, sep="")))
spat_files <- spat_files[spat_files != "desktop.ini"]
raster_read <- function(filename){
  id <- gsub(filename, pattern="iucn_sid_", replacement = "")
  id <- gsub(id, pattern=".csv", replacement = "")
  spp_rast <- data.table::fread(file.path(paste(dir_rasters, "_", cell_size, sep=""), filename))
  if(nrow(spp_rast)>0){
    spp_rast$iucn_sid <- as.numeric(id)
    return(spp_rast)
  }
}
# spat_list <- parallel::mclapply(spat_files, raster_read)
# spat_list <- bind_rows(spat_list)
# write_csv(spat_list, file.path(dir_data, "spat_list.csv"))
spat_list <- data.table::fread(file.path(dir_data, "spat_list.csv"))

cell_ids <- read.csv(file.path(dir_spatial_csvs, "cell_ids.txt"), header=F, col.names = c("cell_id", "lon", "lat"))
cell_id_area <- data.table::fread(file.path(dir_spatial_csvs, "cell_id_area_05.csv"))

allocated_gear_profit <- data.table::fread(file.path(dir_data, "allocated_super_gear_profit.csv"))
allocated_gear_profit <- allocated_gear_profit %>% 
  left_join(cell_ids) %>% 
  left_join(cell_id_area) %>% 
  mutate(catch_km2 = mean_catch/water_area,
         profit_km2 = mean_profit/water_area)

spat_data <- spat_list %>% 
  left_join(cell_ids, by="cell_id") %>%
  mutate(category = if_else(is.na(rgn_category), global_category, rgn_category)) %>% 
  left_join(risk_codes %>% dplyr::select(-c(category)), by=c("category"="code"))

gfw_2016 <- data.table::fread(file.path(dir_spatial_csvs, "gfw_2016_01.csv"))

```

```{r map-setup}

#Load it!
#World <- readOGR(file.path(dir_spatial, "ne_10m_coastline/ne_10m_coastline.shp"))
World <- readOGR(file.path(dir_spatial, "ne_110m_coastline/ne_110m_coastline.shp"), verbose=FALSE) #Switched to using without Caspian Sea for better visuals.

# fortify.shape <- function(x){
#   x@data$id <- rownames(x@data)
#   x.f = fortify(x, region = "id")
#   x.join <- inner_join(x.f, x@data, by = "id")
# }

Forty_World<- fortify(World)

base_map <- ggplot() +
  geom_path(data = Forty_World, aes(x = long,
                                    y = lat,
                                    group = group
  ),
  color = "black",
  size = 0.25) +
  theme_classic() + 
  labs(list(title = "",
            x = "Longitude",
            y = "Latitude")) +
  #scale_fill_gradientn(colours = pal) +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  labs(fill="") + 
  NULL 


# cell_ids <- read.csv(file.path(dir_spatial_csvs, "cell_ids.txt"), header=F, col.names = c("cell_id", "lon", "lat"))
# cell_id_area <- data.table::fread(file.path(dir_spatial_csvs, "cell_id_area_05.csv"))
# water_test <- cell_ids %>% left_join(cell_id_area)
# ggplot() + geom_tile(data=water_test, aes(x=lon, y=lat, fill=water_area))

```

## Supplemental Results


#### Habitat modification
```{r}
text_threats <- read_csv(file.path(dir_data, "narrative_threats_output_tidy.csv"))
trawl_unspec <- text_threats %>% filter(super_code =="trawl unspec") %>% nrow()
trawl_hab <- read_csv(file.path(dir_data, "trawl_habitat_output.csv"))
num_trawl_hab <- nrow(trawl_hab)
num_dynamite <- sum(trawl_hab$dynamite, na.rm=TRUE)
num_destructive <- sum(trawl_hab$destructive, na.rm=TRUE)

```
Of the `r prettyNum(trawl_unspec, big.mark=",")` marine species that have trawling ('trawls unspecificed') identified as a threat, only `r toString(num_trawl_hab)` have habitat modification also identified as a threat. When reviewing the threat description for these species, many of them are identified as two separate threats. `r toString(num_destructive)` of these have 'destructive fishing practices' identified as a threat. 

## Supplemental Figures

Figure \@ref(fig:iucn-categories)
```{r iucn-categories, fig.cap="IUCN category for all marine species (A) and marine species included in this study (B)" }

#devtools::install_github("timcashion/IUCNpalette") #Requires this palette
library(IUCNpalette)
iucn_species <- read.csv(file.path(dir_data, "iucn_species_list.csv"))
all_species <- iucn_species %>% filter(result.taxonid %in% marine_species$iucn_sid) %>% left_join(risk_codes, by=c("result.category"="code"))
all_species <- all_species  %>% mutate(code_current = fct_relevel(code_current, c("DD", "LC", "NT", "VU", "EN", "CR", "EX"))) 
included_species <- all_species %>% filter(result.taxonid %in% species_threats$iucn_sid)
all_species_plot <- ggplot(data=all_species, aes(x=code_current, fill=code_current)) +
  geom_bar() + 
  scale_fill_manual(values= IUCNpalette::iucn_palette(category="All", exclude="NE")) +
  ylab("Number of species") + 
  labs(fill="IUCN Category") + 
  xlab("") + 
  scale_y_continuous(expand=c(0,0)) + 
  theme(legend.position = "none") + 
  NULL 
included_species_plot <- ggplot(data=included_species, aes(x=code_current, fill=code_current)) +
  geom_bar() + 
  scale_fill_manual(values= IUCNpalette::iucn_palette(category="All", exclude="NE")) +
  ylab("") + 
  xlab("") + 
  labs(fill="IUCN Category") + 
  scale_y_continuous(expand=c(0,0)) + 
  theme(legend.position = "none") + 
  NULL 
species_plot_legend <- get_legend(all_species_plot + theme(legend.position = "right"))
plot_grid(all_species_plot, included_species_plot, species_plot_legend, labels=c("A", "B", ""), align="h", nrow=1, rel_heights = 1, rel_widths = c(1,1,0.5))

if(fig_output==TRUE){ #Erase existing manuscript figs and re-output
  ggsave(file.path(dir_supplemental_figs, "IUCN_status_marine_versus_study.png"), dpi=300, width=6, height=4)
}

```


```{r threat-maps-function}
threat_maps <- function(gear=NA, text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data){
  gear_species <- text_threats %>%
    filter(super_code==gear) 
  fishing_dat <- allocated_gear_profit %>% 
    filter(super_code==gear) %>% 
    group_by(lon, lat) %>% 
    summarize(catch_km2 = sum(catch_km2, na.rm=TRUE)) %>% 
    ungroup()
  max_catch <- max(fishing_dat$catch_km2)
  min_catch <- non_min_min(fishing_dat$catch_km2)
  diff <- log10(max_catch) - log10(min_catch)
  breaks_gear <- 10^seq(-2, 1, 1)
  labels_gear <- c("<=0.01", breaks_gear[2:4])
  breaks_gear <- log10(breaks_gear)
  fishing_dat <- fishing_dat %>% 
    mutate(catch_km2 = ifelse(catch_km2<0.01 & catch_km2>0, 0.01, catch_km2),
           catch_km2 = ifelse(catch_km2>10, 10, catch_km2))
  #labels_gear <- round(breaks_gear, 1)
  # labels_gear <-prettyNum(breaks_gear, format="e",digits=3)
  threat_dat <- spat_data %>% 
    filter(iucn_sid %in% gear_species$iucn_sid)  %>% 
    group_by(lon, lat) %>% 
    summarize(n = sum(presence, na.rm = T),
              weighted_score = sum(cat_score, na.rm = T)) %>% 
    ungroup()
  catch_threat <- left_join(fishing_dat, threat_dat) %>% 
    mutate(super_code=gear)
  write_csv(catch_threat, file.path(dir_output, paste(gear, "catch_threat.csv", sep="")))
  gear_map <- base_map + 
    geom_tile(data=fishing_dat, 
              aes(x=lon, y=lat, fill=log10(catch_km2))) +
    labs(fill="Catch (metric tonnes/km2)", x="Longitude", y="Latitude") +
    scale_fill_gradientn(colors=pal, 
                         breaks = breaks_gear,
                         labels = labels_gear, 
                         limits=c(min(breaks_gear)-0.001, max(breaks_gear+0.001)),
                         na.value=null_colour)
  occurrence_map <- base_map + 
    geom_tile(data=threat_dat, 
              aes(x=lon, y=lat, fill=n)) +
    labs(fill="Species occurrence", x="Longitude", y="Latitude")
  threat_map <- base_map + 
    geom_tile(data=threat_dat, 
              aes(x=lon, y=lat, fill=weighted_score)) +
    labs(fill="Weighted threat\nscore", x="Longitude", y="Latitude")
  map_grid <- cowplot::plot_grid(gear_map, 
            occurrence_map,
            threat_map,
            align = "v", 
            rel_widths = c(1,1,1),
            labels="AUTO",
            ncol = 1)
  return(map_grid)
}

```

Also drop x-axes from top 6? and y axes from right column? 

```{r ease-of-conservation-plot-function}
ease_of_conservation <- function(gear=NA, text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data){
  gear_species <- text_threats %>%
    filter(super_code==gear) 
  fishing_dat <- allocated_gear_profit %>% 
    filter(super_code==gear) %>% 
    group_by(lon, lat) %>% 
    summarize(catch_km2 = sum(catch_km2, na.rm=TRUE)) %>% 
    ungroup()
  # max_catch <- max(fishing_dat$catch_km2)
  # min_catch <- non_min_min(fishing_dat$catch_km2)
  # diff <- log10(max_catch) - log10(min_catch)
  # breaks_gear <- 10^seq(-2, 1, 1)
  # labels_gear <- c("<=0.01", breaks_gear[2:4])
  # breaks_gear <- log10(breaks_gear)
  fishing_dat <- fishing_dat %>% 
    mutate(catch_km2 = ifelse(catch_km2<0.01 & catch_km2>0, 0.01, catch_km2),
           catch_km2 = ifelse(catch_km2>10, 10, catch_km2))
  #labels_gear <- round(breaks_gear, 1)
  # labels_gear <-prettyNum(breaks_gear, format="e",digits=3)
  threat_dat <- spat_data %>% 
    filter(iucn_sid %in% gear_species$iucn_sid)  %>% 
    group_by(lon, lat) %>% 
    summarize(n = sum(presence, na.rm = T),
              weighted_score = sum(cat_score, na.rm = T)) %>% 
    ungroup()
  
  map_dat <- full_join(fishing_dat, threat_dat) %>% 
    gather(key="variable", value="value", -lon:-lat) %>% 
    group_by(variable) %>% 
    mutate(value = ifelse(is.na(value), 0, value)) %>% 
    mutate(norm_value = value/max(value),
           perc_value = percent_rank(value)) %>% 
    ungroup()
  easy_conservation <- map_dat %>% 
    mutate(perc_value = ifelse(variable=="catch_km2", 1-perc_value, perc_value)) %>% 
    filter(variable!= "n") %>% 
    group_by(lon, lat) %>% 
    summarize(synth_measure = mean(perc_value))
  easy_conservation_map <- base_map +
    geom_tile(data=easy_conservation, aes(x=lon, y=lat, fill=synth_measure)) +
    labs(fill="Ease of \nConservation Score",
              title = "",
              x = "Longitude",
              y = "Latitude") +
    theme(legend.position = "none")
  return(easy_conservation_map)
  }

```


Add in plots for each gear type of each map type: Catches, species occurence (n), and weighted threat score. 

```{r, fig.width=9, fig.height=15, fig.cap="Bottom trawl: Distribution of catches (A), species occurrence (B), and weighted threat score (C) by gear type"}
bt_threats <- threat_maps(gear="bottom trawl", text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data)
print(bt_threats)

if(fig_output==TRUE){
  ggsave(file.path(dir_supplemental_figs, "bt_threats.png"), dpi=600, width=12, height=15)
}
```

```{r, fig.width=9, fig.height=15, fig.cap="Pelagic trawl: Distribution of catches (A), species occurrence (B), and weighted threat score (C) by gear type"}
pt_threats <- threat_maps(gear="pelagic trawl", text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data)
print(pt_threats)
if(fig_output==TRUE){
  ggsave(file.path(dir_supplemental_figs, "pt_threats.png"), dpi=600, width=12, height=15)
}
```

```{r, fig.width=9, fig.height=15, fig.cap="Longline: Distribution of catches (A), species occurrence (B), and weighted threat score (C) by gear type"}
ll_threats <- threat_maps(gear="longline", text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data)
print(ll_threats)
if(fig_output==TRUE){
  ggsave(file.path(dir_supplemental_figs, "ll_threats.png"), dpi=600, width=12, height=15)
}
```

```{r, fig.width=9, fig.height=15, fig.cap="Purse seine: Distribution of catches (A), species occurrence (B), and weighted threat score (C) by gear type"}
ps_threats <- threat_maps(gear="purse seine", text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data)
print(ps_threats)
if(fig_output==TRUE){
  ggsave(file.path(dir_supplemental_figs, "ps_threats.png"), dpi=600, width=12, height=15)
}
```

```{r, fig.width=9, fig.height=15, fig.cap="Gillnet: Distribution of catches (A), species occurrence (B), and weighted threat score (C) by gear type"}
gn_threats <- threat_maps(gear="gillnet", text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data)
print(gn_threats)
if(fig_output==TRUE){
  ggsave(file.path(dir_supplemental_figs, "gn_threats.png"), dpi=600, width=12, height=15)
}
```

Figure \@ref(fig:ease-of-conservation-plots)
```{r ease-of-conservation-plots, fig.width=12, fig.height=20, fig.cap="Ease of conservation by gear type"}

sau_gear_types <- unique(allocated_gear_profit$super_code)
iucn_gear_types <- unique(text_threats$super_code)
gear_types <- iucn_gear_types[grep(iucn_gear_types, pattern=paste(sau_gear_types, collapse="|"))]


ease_maps <- lapply(gear_types, FUN=ease_of_conservation, text_threats=text_threats, allocated_gear_profit=allocated_gear_profit, spat_data=spat_data)
ease_legend <- cowplot::get_legend(ease_maps[[1]] + theme(legend.position="right", legend.box.margin = margin(0,0,0,12)))

map_grid <- cowplot::plot_grid(plotlist = ease_maps,
            align = "v", 
            rel_widths = rep(1,8),
            ncol = 2)
map_grid_with_legend <- plot_grid(map_grid, ease_legend, rel_widths = c(8,1.25))
print(map_grid_with_legend)
if(fig_output==TRUE){
  ggsave(file.path(dir_supplemental_figs, "ease_of_conservation.png"), dpi=300, width=16)
}
```

