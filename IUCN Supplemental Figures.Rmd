---
title: "Supplemental Figures: "
author: "Tim Cashion, Travis Tai, Vicky Lam, Daniel Pauly, and U. Rashid Sumaila"
date: "`r date()`"
output: bookdown::html_document2
bibliography: MyCollection.bib
always_allow_html: yes
biblio-style: "apalike"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=F, warning=F)
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}


packages <- c("tidyverse", 
              "wesanderson",
              "parallel",
              "bookdown",
              "knitr",
              "cowplot",
              "DiagrammeR"
              )
ipak(packages)

####Directories####
dir_data <- "./data"
dir_spatial <- "./spatial"
dir_figs <- "./figs"
dir_manuscript_figs <- "./figs/manuscript_figs"
dir_supplemental_figs <- "./figs/supplemental_figs"
dir_spatial_csvs <- "./spatial/csvs"
dir_rasters <- "./spatial/spp_rasters"
dir_output <- "./output"

source(here::here("R", "common_fxns.R"))


fig_output <- TRUE
if(fig_output==TRUE){ #Erase existing manuscript figs and re-output
  unlink(paste("./figs/supplemental_figs/", list.files("./figs/supplemental_figs"), sep=""))
}

```

```{r plot-aes}
pal <- wes_palette(name = "Zissou1", n=100, type = c("continuous"))
zissou5 <- wes_palette(name="Zissou1")
theme_set(theme_classic())
#GFW Themes
theme_gfw_paper <-  theme(text = element_text(face="bold", size=12),
        axis.text.x = element_text(size = 12, colour = "black"),
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.line.x = element_line(colour = "black", size = .5),
        axis.line.y = element_line(colour = "black", size = .5),
        legend.position = "bottom",
        axis.title.y = element_text(size = 12, margin=margin(0,15,0,0)),
        axis.title.x = element_text(size = 12, margin=margin(15,0,0,0)),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.margin = unit(c(1,1,1,1), "cm")
        )

cont_fill = 'white'#'grey30' #'grey80'
back_fill =  'white'#'#202A50' #'black' #'#1F2A4F'
cont_color = 'grey60'#'grey30'
#color_grad = c( "#414487", "#2A788E", "#22A884", "#7AD151","#FDE725","#FFC04C")
color_grad = c("#C6DBEF", "#9ECAE1", "#6BAED6","#4292C6" ,"#2171B5", "#084594") #blues
null_colour = "grey50"
```

```{r data}

marine_species <- read.csv(file.path(dir_data, paste( "spp_marine_from_", api_version,".csv", sep="")))
risk_codes <- read.csv(file.path(dir_data, "risk_code_lookup.csv"), stringsAsFactors = F)
species_threats <- read.csv(file.path(dir_data, "species_fishing_threats.csv"), stringsAsFactors = F)
colnames(species_threats) <- gsub(colnames(species_threats), pattern="result\\.", replacement="")
cell_ids <- read.csv(file.path(dir_spatial_csvs, "cell_ids.txt"), header=F, col.names = c("cell_id", "lon", "lat"))
cell_id_area <- data.table::fread(file.path(dir_spatial_csvs, "cell_id_area_05.csv"))

allocated_gear_profit <- data.table::fread(file.path(dir_data, "allocated_super_gear_profit.csv"))
allocated_gear_profit <- allocated_gear_profit %>% 
  left_join(cell_ids) %>% 
  left_join(cell_id_area) %>% 
  mutate(catch_km2 = mean_catch/water_area,
         profit_km2 = mean_profit/water_area)



```

## Supplemental Results


#### Protecting coastal waters

The coastal waters of three EEZs show very different patterns of fishery conservation by gear type (Figure \@ref(fig:eez-protection-gears)). There are many areas where fisheries should be prioritized and other areas where not all fisheries need to be closed to achieve conservation goals. Small scale fisheries show a diversity of scores across these EEZs confirming they are not impactless. Gillnet fisheries have the highest weighted threat score of any gear in each of these EEZs. Bottom trawl fisheries occur in multiple quadrants including many in the fishery prioritization in China's EEZ waters because of their high profitability and relatively low weighted threat scores in these waters. 

```{r eez-protection-gears, fig.cap="Fisheries profits and weighted score by cell (0.5 by 0.5 grid) for three countries exclusive economic zones. Grey dashed lines indicate the median values  (excluding values of 0) across gear types for fisheries profits per km^2^. Note: X- and Y-axes have different scales in each EEZ."}
cell_size <- "05"
eez_cell_ids <- read_csv(file.path(dir_spatial_csvs, paste("eez_cell_ids_", cell_size, ".csv", sep="")))
eez_ids <- read.csv(file.path(dir_spatial_csvs, "eez_ids.csv")) %>% 
  rename(eez_id = EEZID, eez = Name, entity=Entity) %>% 
  dplyr::select(eez_id, eez, entity)

eez_ids <- eez_ids %>% 
  mutate(eez = gsub(eez, pattern="ô", replacement="o"),
         entity = gsub(entity, pattern="ô", replacement="o"),
         eez = gsub(eez, pattern="é", replacement="e"),
         entity = gsub(entity, pattern="é", replacement="e"))


cell_ids <- read.csv(file.path(dir_spatial_csvs, "cell_ids.txt"), header=F, col.names = c("cell_id", "lon", "lat"))
cell_ids_area <- read.csv(file.path(dir_spatial_csvs, paste("cell_id_area_", cell_size,".csv", sep="")))
cell_ids <- cell_ids %>% left_join(cell_ids_area) %>% left_join(eez_cell_ids) %>% left_join(eez_ids)

cell_ids <- cell_ids %>% 
  mutate(eez = ifelse(is.na(eez) & water_area>0, "High seas", eez),
         entity = ifelse(is.na(entity) & water_area>0, "High seas", entity))

files <- list.files(dir_output)[grepl(list.files(dir_output), pattern="_SAU_IUCN_threat_05.csv")]
files <- file.path(dir_output, files)
harmonized_list <- lapply(files, data.table::fread)
files = gsub(files, pattern="_.*", replacement="")
files = gsub(files, pattern=".*/", replacement="")
for (i in 1:length(harmonized_list)){
  harmonized_list[[i]]$super_code <- files[i]
}
harmonized_threats <- bind_rows(harmonized_list)
harmonized_threats <- harmonized_threats %>% left_join(cell_ids)

harmonized_threats <- harmonized_threats %>% 
  mutate(profit_km2 = profit/water_area)

# eez_threats <- eez_threats %>% 
#   gather(key="variable", value="value", -eez)

mean_profit_global <- mean(allocated_gear_profit %>% filter(profit_km2!=0) %>% pull(profit_km2))
mean_wts <- mean(harmonized_threats %>% filter(weighted_score>0) %>% pull(weighted_score))
    
harmonized_threats$category <- NA
harmonized_threats <- harmonized_threats %>% 
  mutate(category = if_else(profit_km2 > mean_profit_global, 
                            if_else(weighted_score > mean_wts, "Fishery competition", "Fishery prioritization"), 
                            if_else(weighted_score > mean_wts, "Easy wins", "Area of low concern")))

harmonized_threats$category <- fct_relevel(as.factor(harmonized_threats$category), c("Fishery competition", "Fishery prioritization",  "Area of low concern", "Easy wins"))


# eezs_of_interest <- c("High seas", "Indonesia")
# eez_threats <- harmonized_threats %>% 
#   filter(eez %in% eezs_of_interest)

entities_of_interest <- c("Australia", "China", "Indonesia")
exclude_gears <- c("other", "pelagic trawl", "drifting longlines")
eez_threats <- harmonized_threats %>% 
  filter(entity %in% entities_of_interest) %>% 
  filter(!super_code %in% exclude_gears) %>% 
  mutate(super_code = str_to_sentence(super_code))

text_color <- "grey10"
text_size <- 4
eez_gear <- ggplot(data=eez_threats, aes(x=weighted_score, y=profit_km2, color=super_code)) +
  geom_point(alpha=0.7) +
  xlab("Weighted threat score") +
  geom_vline(xintercept = mean_wts, color="grey50", lty="dashed") + 
  geom_hline(yintercept = mean_profit_global, color="grey50", lty="dashed") + 
  #scale_color_manual(values=c(zissou5[5], zissou5[4], "grey50", zissou5[1])) +
  labs(color="Gear type") + 
  ylab(expression(paste("Profit per ", km^2))) + 
  #scale_color_manual(values = wes_palette("Darjeeling2")) +
  theme(strip.background = element_blank()) + 
  facet_wrap(~entity, scales="free", nrow=1) + 
  NULL
eez_gear
if(fig_output==TRUE){
  ggsave(plot= eez_gear, 
         file.path(dir_manuscript_figs, "eez-protection-gear.png"), 
         dpi=300, width=8, height=4)
}
```


#### Habitat modification
```{r}
text_threats <- read_csv(file.path(dir_data, "narrative_threats_output_tidy.csv"))
trawl_unspec <- text_threats %>% filter(super_code =="trawl unspec") %>% nrow()
trawl_hab <- read_csv(file.path(dir_data, "trawl_habitat_output.csv"))
num_trawl_hab <- nrow(trawl_hab)
num_dynamite <- sum(trawl_hab$dynamite, na.rm=TRUE)
num_destructive <- sum(trawl_hab$destructive, na.rm=TRUE)

```

Of the `r prettyNum(trawl_unspec, big.mark=",")` marine species that have trawling ('trawls unspecificed') identified as a threat, only `r toString(num_trawl_hab)` have habitat modification also identified as a threat. When reviewing the threat description for these species, many of them are identified as two separate threats. `r toString(num_destructive)` of these have 'destructive fishing practices' identified as a threat. 

## Supplemental discussion
It is important to caveat our study knowing that we cannot fully account for the current extent of humanity's use of the oceans and this study has focused on fisheries. Small-scale fisheries are critical to coastal livelihoods across the world and must not be compromised by overly broad conservation initiatives, but instead included when implementing actions to improve aspects of ocean health (e.g. [@Halpern2012]). 

In addition, while we use catch and fisheries profits as a proxy for importance, these are not adjusted for their importance to the country (i.e., percentage of GDP from fisheries revenues or percentage of animal protein from locally caught fish), nor do they take into account differences in purchasing power parity where $1000 of fisheries profits is much more valuable in poorer countries than in industrialized countries. 

## Supplemental Figures

Figure \@ref(fig:iucn-categories)
```{r iucn-categories, fig.cap="IUCN category for all marine species (A) and marine species included in this study (B)" }

#devtools::install_github("timcashion/IUCNpalette") #Requires this palette
library(IUCNpalette)
iucn_species <- read.csv(file.path(dir_data, "iucn_species_list.csv"))
all_species <- iucn_species %>% filter(result.taxonid %in% marine_species$iucn_sid) %>% left_join(risk_codes, by=c("result.category"="code"))
all_species <- all_species  %>% mutate(code_current = fct_relevel(code_current, c("DD", "LC", "NT", "VU", "EN", "CR", "EX"))) 
included_species <- all_species %>% filter(result.taxonid %in% species_threats$iucn_sid)
all_species_plot <- ggplot(data=all_species, aes(x=code_current, fill=code_current)) +
  geom_bar() + 
  scale_fill_manual(values= IUCNpalette::iucn_palette(category="All", exclude="NE")) +
  ylab("Number of species") + 
  labs(fill="IUCN Category") + 
  xlab("") + 
  scale_y_continuous(expand=c(0,0)) + 
  theme(legend.position = "none") + 
  NULL 
included_species_plot <- ggplot(data=included_species, aes(x=code_current, fill=code_current)) +
  geom_bar() + 
  scale_fill_manual(values= IUCNpalette::iucn_palette(category="All", exclude="NE")) +
  ylab("") + 
  xlab("") + 
  labs(fill="IUCN Category") + 
  scale_y_continuous(expand=c(0,0)) + 
  theme(legend.position = "none") + 
  NULL 
species_plot_legend <- get_legend(all_species_plot + theme(legend.position = "right"))
plot_grid(all_species_plot, included_species_plot, species_plot_legend, labels=c("A", "B", ""), align="h", nrow=1, rel_heights = 1, rel_widths = c(1,1,0.5))

if(fig_output==TRUE){ #Erase existing manuscript figs and re-output
  ggsave(file.path(dir_supplemental_figs, "IUCN_status_marine_versus_study.png"), dpi=300, width=6, height=4)
}

```


