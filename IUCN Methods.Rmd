---
title: "IUCN Methods and Supplemental Methods and Tables"
author: "Tim Cashion et al."
date: "`r date()`"
output: 
  # bookdown::html_document2:
  #   default
  bookdown::word_document2:
    default
bibliography: MyCollection.bib
always_allow_html: yes
#biblio-style: "apalike"
csl: science.csl
---

<!-- Note: Cost is not spatialized so that bottom trawling far offshore by the same country costs the same as bottom trawling on shore. 
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = F)
source(here::here("R", "common_fxns.R"))

packages <- c("tidyverse", 
              "bookdown",
              "knitr",
              "DiagrammeR"
              )
ipak(packages)

####Directories####
dir_data <- "./data"
dir_spatial <- "./spatial"
dir_figs <- "./figs"
dir_manuscript_figs <- "./figs/manuscript_figs"
dir_supplemental_figs <- "./figs/supplemental_figs"
dir_spatial_csvs <- "./spatial/csvs"
dir_rasters <- "./spatial/spp_rasters"
dir_output <- "./output"


```


## Methods
```{r text-values}
iucn_species <- data.table::fread(file.path(dir_data, paste("iucn_species_list_", api_version, ".csv", sep="")))
iucn_species <- iucn_species %>% select(result.taxonid, result.scientific_name) %>% distinct()
unique_species <- length(iucn_species %>% pull(result.scientific_name) %>% unique())

iucn_marine_num <- data.table::fread(file.path(dir_data, paste("spp_marine_from_", api_version, ".csv", sep="")))
iucn_marine_num <- length(iucn_marine_num %>% left_join(iucn_species, by=c("iucn_sid"="result.taxonid")) %>% pull(result.scientific_name) %>% unique())


fishing_threat_num <- length(data.table::fread(file.path(dir_data, "species_fishing_threats.csv")) %>% filter(code=="5.4") %>% left_join(iucn_species, by="result.scientific_name") %>% pull(result.scientific_name) %>% unique())
gear_threat_num <- length(data.table::fread(file.path(dir_data, "narrative_threats_output_tidy.csv")) %>% left_join(iucn_species, by=c("scientific_name"="result.scientific_name")) %>% pull(scientific_name) %>% unique())

text_threats <- read.csv(file.path(dir_data, "narrative_threats_output_tidy.csv")) 
trawler_unspec_num <- length(text_threats %>% filter(super_code =="trawl unspec") %>% pull(scientific_name) %>% unique())

#Numbers used in text
fishing_threat_perc <- round(fishing_threat_num/iucn_marine_num * 100, 1)
iucn_marine_num <- prettyNum(iucn_marine_num, big.mark = ",")
fishing_threat_num <- prettyNum(fishing_threat_num, big.mark = ",")
gear_threat_num <- prettyNum(gear_threat_num, big.mark = ",")

```

### IUCN data 
The International Union for Conservation of Nature (IUCN) maintains the IUCN Red List of Threatened Species (hereafter, 'Red List') that documents the population status and threats of species globally. Species (and sub-populations of species) that are assessed by the IUCN are categorised into one of the following in order of increasing conservation threat: Least Concern, Near Threatened, Vulnerable, Endangered, Critically Endangered, and Extinct. A final category exists of 'Data Deficient' that indicates there is not enough information to properly assess the population status of a species. Together, Vulnerable, Endangered, and Critically Endangered are often grouped together as 'Threatened'. In addition to the categorisation of the threat status, the IUCN provides species range maps, detailed description of threats, and other important information on the species included in the Red List.

Red List Categories, spatial habitat maps, identified threats by species, and a description of threats were gathered from the IUCN API version 2019-2 [@IUCN2019]. The known threats to each marine species were extracted from the IUCN API focusing on threats identified in Category 5: Biological Resource Use. The Red List identifies four different types of fisheries impacts from either intentional or unintentional capture/harvest from the large- or small-scale fisheries. These threats are categorised by the IUCN as unknown, past, no, low, medium, or high impact. In addition, the text from the 'Detailed Threats' and 'Use and Trade' sections for each marine species was extracted from the IUCN API. After extracting the description of the species threats and use and trade information, we tokenized (i.e., separated the text into one word strings) the text extracting standard stop words and searched for single words and bigrams of fishing gears (e.g., 'bottom trawl' or 'longline', see Table S1). Bigrams were used as they can include more specific gear types than single words alone (e.g., 'bottom trawl' versus 'trawl' and 'purse seine' versus 'seine'). The label for different fishing gears analysed are included in Table \@ref(tab:gear-search-table). These were devised to match the IUCN narrative text most closely to relevant *Sea Around Us* gears and Global Fishing Watch gears. 

We accessed spatial species distribution shape files from the Red List for comprehensively assessed groups that include marine organisms [@IUCN2019]. We supplemented this with Bird Life International species distribution files for birds that occur in marine areas [@BirdLifeInternational2018]. Marine molluscs have not been comprehensively assessed (i.e., less than 80% of the species in this group have not been assessed) by the IUCN except for Cone Snails (*Conus* spp.), and this is a gap in our data coverage. We converted the species distribution maps to raster format at various spatial scales to correspond to existing datasets in fisheries research including a 0.5째 by 0.5째, 0.1째 by 0.1째, and 10 km^2^ x 10 km^2^ scale. We rasterised the species distribution files following the same process of [@OHara2019].

We used the same prioritisation of species Categories based on regional assessments where possible as in O'Hara [-@OHara2019]. Here, regional assessments were matched to associated (i.e., overlapping) marine ecoregions [@Spalding2007] that were then associated with their corresponding cells of the spatial grid used. Regional assessments were used in preference of global assessments where possible. 

```{r progressive-refinement-table, fig.cap="Reason for elimination of species from our  final analysis", echo=FALSE, message=F}
#I want to show how we get from all marine species to our narrower list that rely on this habitat to those that we find spatial data for and have fishing gear labelled threats

dir_data <- "./data"
dir_spatial <- "./spatial"

number_iucn_species <- length(data.table::fread(file.path(dir_data, "iucn_species_list_version_2019-2.csv")) %>% pull(result.taxonid) %>% unique())
number_marine_species <- length(data.table::fread(file.path(dir_data, "species_systems.csv")) %>% filter(result.marine_system==TRUE) %>% pull(result.taxonid) %>% unique())
non_marine_species <- number_iucn_species - number_marine_species
number_marine_species_included <- length(data.table::fread(file.path(dir_data, "spp_marine_from_version_2019-2.csv")) %>% pull(iucn_sid) %>% unique())
number_marine_fishing_threats <- length(data.table::fread(file.path(dir_data, "species_fishing_threats.csv")) %>% pull(iucn_sid) %>% unique())


text_threats <- read.csv(file.path(dir_data, "narrative_threats_output_tidy.csv")) 
number_gear_threats <- length(text_threats %>% pull(iucn_sid) %>% unique())

spatial_ids <- gsub(list.files(file.path(dir_spatial, "spp_rasters_05")), pattern=".csv", replacement="")
spatial_ids <- gsub(spatial_ids, pattern="iucn_sid_", replacement="")

number_marine_spatial_files <- length(list.files(file.path(dir_spatial, "spp_rasters_05")))
gear_threats_spatial <- length(text_threats %>% filter(iucn_sid %in% spatial_ids) %>% pull(iucn_sid) %>% unique())
gear_threats_spatial <- prettyNum(gear_threats_spatial, big.mark=",")
      # node [color=red]
      # tab10 [label = '@@10']
      # 
      # node [color=red]
      # tab11 [label = '@@11']

progressive_refinement <- grViz("digraph flowchart {
      # node definitions with substituted label text()
      node [fontname = Helvetica, shape = rectangle, style=filled]        
      
      node [color=grey]
      tab1 [label = '@@1']
      
      node [color=LightSteelBlue]
      tab2 [label = '@@2']
      
      node [color=grey]
      tab3 [label = '@@3']
      
      node [color=LightSteelBlue]
      tab4 [label = '@@4']

      node [color=grey]
      tab5 [label = '@@5']

      node [color=LightSteelBlue]
      tab6 [label = '@@6']
      
      node [color=grey]
      tab7 [label = '@@7']
    

      # edge definitions with the node IDs
      tab1 -> tab2;
      tab1 -> tab3;
      tab3 -> tab4;
      tab3 -> tab5;
      tab5 -> tab6;
      tab5 -> tab7;
      
      }

      [1]: 'IUCN Red List Species (n = 108,161)'
      [2]: 'Non-marine species (n = 93,290)'
      [3]: 'Marine species (n = 14,871)'
      [4]: 'No fishing gear type data (n= 10,184)'
      [5]: 'Fishing gear type listed in text (n= 4,687)'
      [6]: 'No spatial data (n= 2,461)'
      [7]: 'Has spatial data (n= 2,226)'
      ")
progressive_refinement

      # node [color=LightSteelBlue]
      # tab8 [label = '@@8']
      # 
      # node [color=grey]
      # tab9 [label = '@@9']
# tab7 -> tab8;
#       tab7 -> tab9;
      # [4]: 'Fishing is not a threat (n= 10,311)'
      # [5]: 'Fishing is a threat (n= 4,560)'

```

The Red List contains detailed information on the species system and habitat types. The system assigns species to terrestrial, freshwater, and marine ecosystems (with species able to occur in multiple ecosystems) and this was used to restrict our analysis to marine species. In addition, we restricted those within the marine ecosystem to specific habitats to eliminate species whose are not dependent on the marine environment nor likely to be affected by fisheries, following O'Hara et al. [-@OHara2019]. After restricting our analysis to marine dependent species that are threatened by fishing gears and have species range maps available from the IUCN or BirdLife International, our analysis focused on `r gear_threats_spatial` number of species (Fig S3).

### Fisheries data  
The *Sea Around Us* has reconstructed marine fisheries catches for all marine countries and territories from 1950 to present. The process of reconstruction supplements and corrects reported fisheries catches with estimates of known to be excluded fishing sectors (e.g., artisanal and recreational fishing) and practices (e.g., discarding) [@Zeller2016]. These catches are spatially allocated according to a rule-based assignment and based on known information on where the fishery was operating (within domestic EEZs, foreign EEZs, the high seas, etc.). The spatial scale used is 0.5째 by 0.5째.

The reconstructed catches were then assigned to their respective fishing gear types for industrial and small-scale sectors. This process relied on similar methods as the catch reconstructions relying on official catch statistics by gear type, as well as fisheries reports, catch surveys, newspaper articles, and other grey literature. The process by which each countries fishing gear was assigned is documented in Cashion [-@Cashion2018; -@Cashion2018a]. The result is a catch database with gear information included for all catches. 

We used the *Sea Around Us* database (v.47) for catches by gear type [@Pauly2015; @Cashion2018a] and were accessed from the *Sea Around Us* database by the first author. This database includes spatially allocated reconstructed fisheries catches by gear type and taxon for all fishing countries and territories of the world. The spatial scale of this dataset is 0.5째 by 0.5째 and has been used in many global fisheries studies [@Gremillet2018; @Schiller2018]. 

In addition, we use the corollary Fisheries Economics Research Unit (FERU) ex-vessel price database that includes reported and estimated first-sale prices for all taxa for each fishing country by year [@Tai2017] to incorporate the potential lost revenues for fisheries closures in areas of high biological importance. Revenue is calculated as the ex-vessel price (real 2010 USD per metric tonne) of a specific taxon caught by a country in a given year multiplied by its landings amount in metric tonnes. 

Due to the importance of gear to our analysis, and its importance as a determinant on the ex-vessel price of fish [@Lee2014; @Asche2012; @Mcconnell2000], we modify the ex-vessel prices by a gear multiplier. We determine this gear multiplier through a hedonic pricing model where gear type is an explanatory variable of the ex-vessel fish price. 

First, we combined two datasets that report fisheries ex-vessel revenues by gear type and species. The first is the U.S. National Marine Fisheries Service annual commercial landings by gear type [@NMFS2017]. The second is the monthly landings by gear type, port and species of the UK's fisheries [@MarineManagementOrganisation2017]. We harmonized the gear types listed in each to match our existing dataset gear types. While these two datasets are not representative of global fisheries nor ex-vessel prices for all species, they give adequate coverage to derive the effect of different gear types used for catching different species and how it modifies ex-vessel prices. 

We then used a fixed-effects model with linear regression to derive the effect of changing gear type on the ex-vessel price $Price_{xyzt}$ for species $x$, gear $y$, in country $z$ in year $t$. We used the natural logarithm of landings and prices as these variables are closer to a normal distribution when log-transformed, and thus reduces potential heteroscedasticity in our residuals. We also use the country, species, and year as explanatory variables to account for other changes in the price both over time  and between these different markets. 

Our regression equation is:

$ln(Price_{xyzt}) = \beta_0 + \beta_1Gear_y + \beta_2ln(L_{xyzt}) + \beta_3Species_x + \beta_4Year_t + \beta_5Country_z$ (1)  

We used the estimated gear-type coefficients as gear specific multipliers $\beta_1_{y}$ that will modify the ex-vessel price of fish caught (Table \@ref(tab:gear-multiplier-table)).

Finally, we used an updated version of FERU's cost of fishing database [@Lam2011] to account for the cost of fishing that varies by country and gear type. Cost of fishing is broken down into its component parts in the database (e.g., fuel, labour, capital, maintenance, etc.), and here we use the total cost by gear type and country per tonne of fish landed ($C_{yz}$). Where the cost of fishing was not available for a particular gear and country, we used the regional average for that gear type, and where this was not possible we used the average cost across gear types for the region. We used the FAO socioeconomic regions for this stage of the analysis. We then derive the profit by gear type and country for each cell $i$ , based on the catch by gear type multiplied by the ex-vessel price multiplied by the gear type multiplier ($M_{y}$) minus the cost of fishing for that amount of landings. Therefore, profit (*P*) in cell *i* is equal to: 

$P_{i} = \sum_{x=1}^{x} (L_{xyi} * P_{x} * M_{y}) - (L_{xyi} * C_{y})$ (2)  

Both catch and profits are expressed throughout in tonnes/km^2^ and $/km^2^ calculated based on the water area in each 0.5째 by 0.5째 cell.

Our analysis focuses on the trade-offs among different fisheries with specific gear types. As such, we did not use the Global Fishing Watch data where gear types are often aggregated (bottom and pelagic trawlers grouped together as trawlers), or only represent a narrow subset of the fleet (e.g., drifting longlines) [@Kroodsma2018a]. 

### Analysis

First, we analysed the major fishing gear threats based on their appearance in the narrative text of the Red List species profiles. We associated these descriptors to their gear types and examined the number of species by Red List Category and weighted threat status by gear type. We used a linearised weighted scoring method to weight the presence of a species by its IUCN Category (e.g., 'Least Concern' = 0, 'Endangered'=0.6, etc., Table S2) [@OHara2019]. Older and outdated categories were updated to their current descriptors such as 'Lower Risk/near threatened' to 'Near Threatened'. 

We aim to map areas of high fisheries interest and high conservation concern. The areas with high overlap between conservation concern but low fisheries catches and effort are areas that could be fully protected from these threats for the long term (termed here, 'easy wins'). However, the areas with high overlap of fisheries interest and high conservation concern are where the impacts on species may be greatest both in terms of fisheries threats and the potential benefits for conservation from fisheries closures. 

```{r conceptual-figure, fig.cap="Theoretical basis for competition between fisheries and conservation", dpi=150, fig.width=3.5, fig.height=3.5}

#mod size:
x <- c(seq(-9,9, 1), rep(0,19))
y <- c(rep(0,19),seq(-9,9, 1))
group <- c(rep(0,19),rep(1,19))

df <- tibble(x,y, group)
#V4:
conceptual_figure <- ggplot(data=df, aes(x=x,y=y, group=group)) +
  geom_line(alpha=0.5) +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        legend.position="none",
        panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),plot.background=element_blank()) + 
  ylab("Fishery") + 
  xlab("Conservation") + 
  #scale_x_discrete(position = "top") +
  annotate("text", x = -4, y = -5, label = "Areas of low concern", size=3, color="grey40") + 
  annotate("text", x = -4, y = 5, label = "Fishery prioritisation", size=3, color="grey40") + 
  annotate("text", x = 5, y = 5, label = "Competition", size=3, color="grey40") + 
  annotate("text", x = 5, y = -5, label = "Conservation prioritisation", size=3, color="grey40") + 
  annotate("text", x = -4, y = 9, label = "Low", size=3, color="grey40") + 
  annotate("text", x = 4, y = 9, label = "High", size=3, color="grey40") + 
  annotate("text", x = -9, y = 4, label = "High", size=3, color="grey40") + 
  annotate("text", x = -9, y = -4, label = "Low", size=3, color="grey40") + 
  geom_vline(xintercept = -8, alpha=0.5) + 
  geom_hline(yintercept= 8, alpha=0.5) + 
  NULL
conceptual_figure
#ggsave("./figs/conceptual_figure4.png")

```

We use three main metrics frequently in our analysis. First, we use the biodiversity risk score developed by O'Hara et al. [-@OHara2019]. This indicator is a measure of the average conservation threat status of an area of the marine environment (Equation 1). It is expressed as:

$Biodiversity Risk Score_{cell} =  \frac{1}{N_{cell}}\sum_{i=1}^{N_{cell}}s_{i}$ (3)   

Where $N$ is number of assessed species in the $cell$ , $s_{i}$ is the conservation status ($s$) of species ($i$). All biodiversity risk scores are thus values of 0-1 that roughly correspond to the linear IUCN Category scale described above (Table \@ref(tab:risk-code-lookup)). 

Second, we adapt this metric so that it isn't normalised to the mean threat in the cell but representative of scale (number of species) and severity (IUCN Category) of threat. This metric is named the weighted threat score defined as the sum of species present multiplied by their threat category numeric score, but is not divided by the number of species in a given cell. We do not normalise by this to highlight areas of conservation concern based on the number of species in that cell in addition to their threat status. 

$WeightedThreatScore_{i,g} = \sum_{i=1}^{N_{cell}}s_{i}$ (4)   


```{r}

#Removed text on other metrics removed from manuscript. 
# The third metric is the WTS divided by the fisheries revenue from that area (0.5째 by 0.5째 cell). High values for this metric indicate areas with high fisheries revenues for relatively low conservation costs, whereas low values indicate the opposite. This can be used as a scoring metric for areas where conservation is more or less costly to implement for fisheries. 
# 
# $\$/ WTS = Revenue_{i,g} / WTS_{i,g}$ (5)  
# 
# In addition, we adopt the Fishing Exposure Index (FEI) from Queiroz et al. [-@Queiroz2019] to understand the spatial overlap of species with Global Fishing Watch data. This index was used to understand exposure of 23 species of pelagic sharks that had been fitted with tracking tags to industrial longline and purse seine fishing vessels (using GFW data;equtaion 4). The data is thus generalisable to understand sharks exposure to these gears given their actual locations. The FEI is originally defined as:  
# 
# $FEI_{g,i} = \frac{\sum_{i=1}^{n}f_id_i}{n}$ (6)  
# 
# Where $f_i$ is fishing effort in grid cell $i$ occupied, $d_i$ is the relative density contribution within cell $i$ of a given shark's , and $n$ is the number of grid cells occupied by an individual in that month. Here we adapt the $FEI$ to overlap with species range maps, instead of tagged individuals (equation 5). Our adapted equation is:  
# 
# $FEI = \frac{\sum_{i=1}^{n}f_{i,g}s_{i,g}}{n}$ (7)    
# 
# Where $f$ and $i$ remain the same, $g$ is a specific fishing gear, and $s_{i,g}$ is a species category score (0-1). This index is different from the weighted threat score as it is normalised by the number of species. In this way, it is a gear-specific fishing overlap index similar to the biodiversity risk score from O'Hara [-@OHara2019], but is based off industrial fishing effort data. 
#Maps use the Natural Earth shapefiles for coastlines (110m; www.naturalearthdata.com).

```


This analysis was conducted in R [@RCoreTeam2017], and used the tidyverse [@Wickham2016], rMarkdown [@Baumer2015], tidytext [@Fay2018]; gridExtra [@Auguie2017]; sf [@Pebesma2019], rgdal [@Pebesma2012], cowplot [@Huber2017a], and wesanderson [@Ram2018] packages. All code and outputs are available at www.github.com/timcashion/iucnfishingthreats. 
For more information on our data sources and methods, see the supplemental methods. 

![Figure 3. Conceptual methods figure.](./figs/methods_figure/methods_figure1_alt.png)


## Supplemental methods 


## Supplemental Tables

Table S1. 
```{r risk-code-lookup}
risk_code_lookup <- read_csv("./data/risk_code_lookup.csv")
colnames(risk_code_lookup) <- c("Former code", "Category", "Current Code", "Category Score")
kable(risk_code_lookup, caption="Weighting of IUCN Categories")
```

Table S2. 
```{r gear-search-table}
gear_search_table <- read_csv("./output/gear_search_terms_table.csv")
kable(gear_search_table, caption="Search terms used for identifying gear types in IUCN narrative text.")
```

Table S3. 
```{r sau-gear-table}
sau_gear_table <- read_csv("./data/sau_gear_table.csv") %>% dplyr::select(-c(gear_id, notes))
sau_gear_table <- sau_gear_table %>% 
  mutate(name = str_to_sentence(name),
         super_code = str_to_sentence(super_code))
colnames(sau_gear_table) <- c("Gear type", "Super code")
kable(sau_gear_table, caption="Gear types identified in the *Sea Around Us* database.")
```

Table S4. 
```{r gear-multiplier-table}
gear_multiplier_table <- read_csv("./data/gear_price_multipliers.csv")
gear_multiplier_table <- gear_multiplier_table %>% 
  mutate(super_code = str_to_sentence(super_code)) %>% 
  mutate(p.value = ifelse(super_code %in% c("Unknown", "Bottom trawl"), "Not Estimated", "***"))

colnames(gear_multiplier_table) <- str_to_title(colnames(gear_multiplier_table))
kable(gear_multiplier_table, caption="Regression results for gear types used and their gear multipliers used", digits=3)

```

Table S5
```{r hs-categorization-table}
hs_categ <- read_csv("./output/hs_area_categorization.csv")
hs_categ$water_area <- hs_categ$water_area/1000000

colnames(hs_categ) <- c("Category", "Water Area (million km2)", "Proportion of High Seas (%)")
kable(hs_categ, digits = 2, caption="Area of high seas by categorization")
```


## Supplemental Figures 


